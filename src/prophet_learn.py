import pandas as pd
import numpy as np
import os
from prophet import Prophet
import jpholiday
from sklearn.metrics import mean_squared_error, mean_absolute_error
from datetime import timedelta
import joblib

# 事前に求めたパラメータの辞書（例）
best_params_dict = {3: {'weekly_order': 6, 'daily_order': 14}, 4: {'weekly_order': 4, 'daily_order': 20}, 5: {'weekly_order': 10, 'daily_order': 18}, 6: {'weekly_order': 7, 'daily_order': 7}, 7: {'weekly_order': 7, 'daily_order': 18}, 8: {'weekly_order': 8, 'daily_order': 19}, 10: {'weekly_order': 9, 'daily_order': 16}, 11: {'weekly_order': 3, 'daily_order': 19}, 12: {'weekly_order': 10, 'daily_order': 18}, 13: {'weekly_order': 7, 'daily_order': 20}, 14: {'weekly_order': 3, 'daily_order': 19}, 15: {'weekly_order': 9, 'daily_order': 19}, 16: {'weekly_order': 3, 'daily_order': 20}, 17: {'weekly_order': 8, 'daily_order': 9}, 18: {'weekly_order': 9, 'daily_order': 20}, 20: {'weekly_order': 10, 'daily_order': 16}, 21: {'weekly_order': 6, 'daily_order': 9}, 22: {'weekly_order': 8, 'daily_order': 7}, 23: {'weekly_order': 8, 'daily_order': 20}, 24: {'weekly_order': 3, 'daily_order': 17}, 25: {'weekly_order': 3, 'daily_order': 18}, 27: {'weekly_order': 10, 'daily_order': 20}, 28: {'weekly_order': 10, 'daily_order': 8}, 30: {'weekly_order': 10, 'daily_order': 20}, 31: {'weekly_order': 6, 'daily_order': 8}, 33: {'weekly_order': 9, 'daily_order': 11}, 34: {'weekly_order': 7, 'daily_order': 11}, 35: {'weekly_order': 10, 'daily_order': 5}, 36: {'weekly_order': 6, 'daily_order': 9}, 37: {'weekly_order': 9, 'daily_order': 10}, 38: {'weekly_order': 7, 'daily_order': 19}, 40: {'weekly_order': 8, 'daily_order': 18}, 41: {'weekly_order': 7, 'daily_order': 17}, 42: {'weekly_order': 8, 'daily_order': 13}, 43: {'weekly_order': 8, 'daily_order': 14}, 44: {'weekly_order': 8, 'daily_order': 20}, 45: {'weekly_order': 5, 'daily_order': 20}, 46: {'weekly_order': 9, 'daily_order': 20}, 47: {'weekly_order': 10, 'daily_order': 20}, 48: {'weekly_order': 7, 'daily_order': 7}, 49: {'weekly_order': 6, 'daily_order': 14}, 50: {'weekly_order': 10, 'daily_order': 16}, 53: {'weekly_order': 7, 'daily_order': 16}, 54: {'weekly_order': 4, 'daily_order': 9}, 55: {'weekly_order': 8, 'daily_order': 10}, 56: {'weekly_order': 8, 'daily_order': 14}, 57: {'weekly_order': 10, 'daily_order': 16}, 58: {'weekly_order': 10, 'daily_order': 11}, 59: {'weekly_order': 5, 'daily_order': 12}, 60: {'weekly_order': 4, 'daily_order': 18}, 61: {'weekly_order': 6, 'daily_order': 17}, 62: {'weekly_order': 10, 'daily_order': 20}, 63: {'weekly_order': 5, 'daily_order': 18}, 64: {'weekly_order': 5, 'daily_order': 20}, 66: {'weekly_order': 10, 'daily_order': 20}, 67: {'weekly_order': 5, 'daily_order': 20}, 68: {'weekly_order': 6, 'daily_order': 10}, 69: {'weekly_order': 4, 'daily_order': 18}, 70: {'weekly_order': 4, 'daily_order': 14}, 71: {'weekly_order': 6, 'daily_order': 17}, 72: {'weekly_order': 3, 'daily_order': 5}, 77: {'weekly_order': 5, 'daily_order': 15}, 78: {'weekly_order': 10, 'daily_order': 18}, 79: {'weekly_order': 5, 'daily_order': 6}, 80: {'weekly_order': 5, 'daily_order': 5}, 82: {'weekly_order': 8, 'daily_order': 18}, 83: {'weekly_order': 3, 'daily_order': 9}, 84: {'weekly_order': 9, 'daily_order': 20}, 85: {'weekly_order': 8, 'daily_order': 9}, 86: {'weekly_order': 7, 'daily_order': 15}, 88: {'weekly_order': 6, 'daily_order': 20}, 89: {'weekly_order': 7, 'daily_order': 16}, 90: {'weekly_order': 7, 'daily_order': 17}, 91: {'weekly_order': 5, 'daily_order': 8}, 92: {'weekly_order': 7, 'daily_order': 9}, 93: {'weekly_order': 7, 'daily_order': 20}, 94: {'weekly_order': 9, 'daily_order': 16}, 95: {'weekly_order': 10, 'daily_order': 20}, 96: {'weekly_order': 6, 'daily_order': 9}, 97: {'weekly_order': 9, 'daily_order': 19}, 102: {'weekly_order': 9, 'daily_order': 16}, 103: {'weekly_order': 9, 'daily_order': 9}, 104: {'weekly_order': 7, 'daily_order': 9}, 105: {'weekly_order': 5, 'daily_order': 15}, 106: {'weekly_order': 9, 'daily_order': 15}, 107: {'weekly_order': 8, 'daily_order': 20}, 108: {'weekly_order': 9, 'daily_order': 17}, 109: {'weekly_order': 10, 'daily_order': 15}, 110: {'weekly_order': 7, 'daily_order': 16}, 111: {'weekly_order': 8, 'daily_order': 13}, 112: {'weekly_order': 8, 'daily_order': 15}, 113: {'weekly_order': 9, 'daily_order': 17}, 116: {'weekly_order': 8, 'daily_order': 14}, 117: {'weekly_order': 3, 'daily_order': 14}, 118: {'weekly_order': 6, 'daily_order': 5}, 119: {'weekly_order': 8, 'daily_order': 9}, 120: {'weekly_order': 6, 'daily_order': 16}, 121: {'weekly_order': 8, 'daily_order': 11}, 122: {'weekly_order': 10, 'daily_order': 10}, 124: {'weekly_order': 6, 'daily_order': 19}, 125: {'weekly_order': 9, 'daily_order': 14}, 126: {'weekly_order': 7, 'daily_order': 14}, 127: {'weekly_order': 4, 'daily_order': 20}, 128: {'weekly_order': 3, 'daily_order': 17}, 129: {'weekly_order': 10, 'daily_order': 9}, 130: {'weekly_order': 5, 'daily_order': 17}, 131: {'weekly_order': 3, 'daily_order': 17}, 132: {'weekly_order': 9, 'daily_order': 11}, 133: {'weekly_order': 6, 'daily_order': 8}, 134: {'weekly_order': 5, 'daily_order': 13}, 135: {'weekly_order': 9, 'daily_order': 11}, 136: {'weekly_order': 3, 'daily_order': 10}, 137: {'weekly_order': 6, 'daily_order': 10}, 138: {'weekly_order': 7, 'daily_order': 20}, 139: {'weekly_order': 3, 'daily_order': 17}, 140: {'weekly_order': 8, 'daily_order': 5}, 141: {'weekly_order': 9, 'daily_order': 20}, 142: {'weekly_order': 10, 'daily_order': 5}, 143: {'weekly_order': 5, 'daily_order': 17}, 144: {'weekly_order': 8, 'daily_order': 10}, 145: {'weekly_order': 7, 'daily_order': 15}, 146: {'weekly_order': 9, 'daily_order': 19}, 147: {'weekly_order': 10, 'daily_order': 13}, 148: {'weekly_order': 9, 'daily_order': 15}, 149: {'weekly_order': 10, 'daily_order': 14}, 150: {'weekly_order': 5, 'daily_order': 18}, 151: {'weekly_order': 9, 'daily_order': 11}, 152: {'weekly_order': 9, 'daily_order': 10}, 153: {'weekly_order': 7, 'daily_order': 11}, 154: {'weekly_order': 3, 'daily_order': 15}, 155: {'weekly_order': 9, 'daily_order': 12}, 156: {'weekly_order': 3, 'daily_order': 9}, 158: {'weekly_order': 8, 'daily_order': 9}, 159: {'weekly_order': 7, 'daily_order': 11}, 160: {'weekly_order': 9, 'daily_order': 9}, 161: {'weekly_order': 8, 'daily_order': 12}, 162: {'weekly_order': 9, 'daily_order': 11}, 163: {'weekly_order': 4, 'daily_order': 16}, 164: {'weekly_order': 7, 'daily_order': 7}, 165: {'weekly_order': 6, 'daily_order': 15}, 166: {'weekly_order': 10, 'daily_order': 15}, 167: {'weekly_order': 9, 'daily_order': 10}, 168: {'weekly_order': 10, 'daily_order': 14}, 169: {'weekly_order': 9, 'daily_order': 18}, 170: {'weekly_order': 8, 'daily_order': 11}, 171: {'weekly_order': 3, 'daily_order': 18}, 172: {'weekly_order': 5, 'daily_order': 18}, 173: {'weekly_order': 7, 'daily_order': 19}, 174: {'weekly_order': 10, 'daily_order': 20}, 175: {'weekly_order': 8, 'daily_order': 20}, 176: {'weekly_order': 9, 'daily_order': 17}, 177: {'weekly_order': 5, 'daily_order': 18}, 178: {'weekly_order': 3, 'daily_order': 10}, 179: {'weekly_order': 4, 'daily_order': 13}, 180: {'weekly_order': 10, 'daily_order': 15}, 181: {'weekly_order': 4, 'daily_order': 13}, 182: {'weekly_order': 9, 'daily_order': 16}, 183: {'weekly_order': 5, 'daily_order': 14}, 184: {'weekly_order': 8, 'daily_order': 17}, 185: {'weekly_order': 5, 'daily_order': 7}, 186: {'weekly_order': 6, 'daily_order': 16}, 187: {'weekly_order': 9, 'daily_order': 16}, 188: {'weekly_order': 9, 'daily_order': 20}, 189: {'weekly_order': 7, 'daily_order': 15}, 190: {'weekly_order': 9, 'daily_order': 15}, 191: {'weekly_order': 3, 'daily_order': 15}, 192: {'weekly_order': 3, 'daily_order': 18}, 193: {'weekly_order': 7, 'daily_order': 18}, 194: {'weekly_order': 10, 'daily_order': 15}, 195: {'weekly_order': 7, 'daily_order': 11}, 196: {'weekly_order': 5, 'daily_order': 11}, 197: {'weekly_order': 9, 'daily_order': 20}, 198: {'weekly_order': 5, 'daily_order': 16}, 199: {'weekly_order': 3, 'daily_order': 17}, 200: {'weekly_order': 5, 'daily_order': 17}, 201: {'weekly_order': 5, 'daily_order': 16}, 202: {'weekly_order': 5, 'daily_order': 10}, 203: {'weekly_order': 3, 'daily_order': 12}, 204: {'weekly_order': 3, 'daily_order': 15}, 205: {'weekly_order': 9, 'daily_order': 14}, 206: {'weekly_order': 9, 'daily_order': 12}, 207: {'weekly_order': 8, 'daily_order': 20}, 211: {'weekly_order': 10, 'daily_order': 5}, 212: {'weekly_order': 6, 'daily_order': 14}, 213: {'weekly_order': 3, 'daily_order': 19}, 215: {'weekly_order': 7, 'daily_order': 17}, 216: {'weekly_order': 9, 'daily_order': 13}, 217: {'weekly_order': 5, 'daily_order': 16}, 218: {'weekly_order': 8, 'daily_order': 13}, 220: {'weekly_order': 3, 'daily_order': 17}, 222: {'weekly_order': 10, 'daily_order': 10}, 223: {'weekly_order': 5, 'daily_order': 17}, 224: {'weekly_order': 4, 'daily_order': 13}, 225: {'weekly_order': 10, 'daily_order': 17}, 227: {'weekly_order': 9, 'daily_order': 15}, 228: {'weekly_order': 4, 'daily_order': 7}, 229: {'weekly_order': 9, 'daily_order': 15}, 230: {'weekly_order': 7, 'daily_order': 18}, 231: {'weekly_order': 6, 'daily_order': 15}, 232: {'weekly_order': 10, 'daily_order': 18}, 234: {'weekly_order': 3, 'daily_order': 20}, 235: {'weekly_order': 10, 'daily_order': 16}, 236: {'weekly_order': 3, 'daily_order': 14}, 237: {'weekly_order': 5, 'daily_order': 20}, 239: {'weekly_order': 8, 'daily_order': 20}, 240: {'weekly_order': 7, 'daily_order': 8}, 241: {'weekly_order': 9, 'daily_order': 18}, 242: {'weekly_order': 9, 'daily_order': 18}, 243: {'weekly_order': 9, 'daily_order': 18}, 244: {'weekly_order': 3, 'daily_order': 10}, 245: {'weekly_order': 5, 'daily_order': 8}, 246: {'weekly_order': 8, 'daily_order': 19}, 247: {'weekly_order': 10, 'daily_order': 16}, 248: {'weekly_order': 3, 'daily_order': 9}, 249: {'weekly_order': 6, 'daily_order': 17}, 250: {'weekly_order': 7, 'daily_order': 18}, 251: {'weekly_order': 5, 'daily_order': 17}, 252: {'weekly_order': 6, 'daily_order': 18}, 254: {'weekly_order': 8, 'daily_order': 18}, 255: {'weekly_order': 4, 'daily_order': 16}, 256: {'weekly_order': 8, 'daily_order': 9}, 257: {'weekly_order': 3, 'daily_order': 20}, 258: {'weekly_order': 8, 'daily_order': 16}, 259: {'weekly_order': 4, 'daily_order': 20}, 262: {'weekly_order': 9, 'daily_order': 18}, 264: {'weekly_order': 10, 'daily_order': 20}, 265: {'weekly_order': 8, 'daily_order': 9}, 266: {'weekly_order': 10, 'daily_order': 15}, 267: {'weekly_order': 8, 'daily_order': 20}, 268: {'weekly_order': 4, 'daily_order': 7}, 269: {'weekly_order': 7, 'daily_order': 10}, 270: {'weekly_order': 9, 'daily_order': 15}, 271: {'weekly_order': 3, 'daily_order': 17}, 273: {'weekly_order': 10, 'daily_order': 15}, 274: {'weekly_order': 8, 'daily_order': 14}, 276: {'weekly_order': 4, 'daily_order': 7}, 277: {'weekly_order': 10, 'daily_order': 11}, 278: {'weekly_order': 10, 'daily_order': 12}, 279: {'weekly_order': 5, 'daily_order': 15}, 280: {'weekly_order': 5, 'daily_order': 20}, 281: {'weekly_order': 5, 'daily_order': 20}, 282: {'weekly_order': 7, 'daily_order': 17}, 283: {'weekly_order': 8, 'daily_order': 19}, 284: {'weekly_order': 8, 'daily_order': 19}, 285: {'weekly_order': 5, 'daily_order': 18}, 286: {'weekly_order': 9, 'daily_order': 18}, 287: {'weekly_order': 8, 'daily_order': 9}, 288: {'weekly_order': 10, 'daily_order': 5}, 289: {'weekly_order': 6, 'daily_order': 20}, 291: {'weekly_order': 4, 'daily_order': 16}, 293: {'weekly_order': 4, 'daily_order': 15}, 294: {'weekly_order': 7, 'daily_order': 17}, 296: {'weekly_order': 9, 'daily_order': 13}, 300: {'weekly_order': 6, 'daily_order': 9}, 302: {'weekly_order': 9, 'daily_order': 18}, 303: {'weekly_order': 8, 'daily_order': 16}, 304: {'weekly_order': 5, 'daily_order': 13}, 305: {'weekly_order': 6, 'daily_order': 14}, 306: {'weekly_order': 9, 'daily_order': 15}, 307: {'weekly_order': 4, 'daily_order': 14}, 308: {'weekly_order': 10, 'daily_order': 19}, 309: {'weekly_order': 8, 'daily_order': 20}, 310: {'weekly_order': 10, 'daily_order': 18}, 311: {'weekly_order': 7, 'daily_order': 16}, 315: {'weekly_order': 8, 'daily_order': 16}, 316: {'weekly_order': 8, 'daily_order': 20}, 319: {'weekly_order': 7, 'daily_order': 5}, 320: {'weekly_order': 10, 'daily_order': 17}, 321: {'weekly_order': 10, 'daily_order': 19}, 322: {'weekly_order': 7, 'daily_order': 11}, 323: {'weekly_order': 8, 'daily_order': 14}, 324: {'weekly_order': 9, 'daily_order': 16}, 325: {'weekly_order': 9, 'daily_order': 20}, 326: {'weekly_order': 9, 'daily_order': 15}, 327: {'weekly_order': 3, 'daily_order': 12}, 328: {'weekly_order': 7, 'daily_order': 20}, 329: {'weekly_order': 10, 'daily_order': 20}, 330: {'weekly_order': 7, 'daily_order': 9}, 331: {'weekly_order': 10, 'daily_order': 19}, 332: {'weekly_order': 9, 'daily_order': 15}, 334: {'weekly_order': 9, 'daily_order': 15}, 335: {'weekly_order': 7, 'daily_order': 14}, 336: {'weekly_order': 9, 'daily_order': 14}, 337: {'weekly_order': 10, 'daily_order': 11}, 338: {'weekly_order': 6, 'daily_order': 20}, 339: {'weekly_order': 6, 'daily_order': 20}, 340: {'weekly_order': 8, 'daily_order': 14}, 341: {'weekly_order': 6, 'daily_order': 17}, 342: {'weekly_order': 3, 'daily_order': 20}, 343: {'weekly_order': 4, 'daily_order': 17}, 344: {'weekly_order': 3, 'daily_order': 9}, 345: {'weekly_order': 9, 'daily_order': 19}, 346: {'weekly_order': 7, 'daily_order': 19}, 347: {'weekly_order': 8, 'daily_order': 8}, 348: {'weekly_order': 10, 'daily_order': 19}, 349: {'weekly_order': 10, 'daily_order': 17}, 350: {'weekly_order': 8, 'daily_order': 16}, 351: {'weekly_order': 3, 'daily_order': 9}, 352: {'weekly_order': 5, 'daily_order': 15}, 353: {'weekly_order': 7, 'daily_order': 18}, 354: {'weekly_order': 7, 'daily_order': 11}, 355: {'weekly_order': 10, 'daily_order': 20}, 356: {'weekly_order': 8, 'daily_order': 10}, 357: {'weekly_order': 10, 'daily_order': 9}, 358: {'weekly_order': 9, 'daily_order': 13}, 360: {'weekly_order': 9, 'daily_order': 20}, 361: {'weekly_order': 5, 'daily_order': 16}, 362: {'weekly_order': 3, 'daily_order': 19}, 363: {'weekly_order': 8, 'daily_order': 18}, 364: {'weekly_order': 10, 'daily_order': 19}, 365: {'weekly_order': 3, 'daily_order': 11}, 366: {'weekly_order': 5, 'daily_order': 19}, 367: {'weekly_order': 3, 'daily_order': 20}, 368: {'weekly_order': 3, 'daily_order': 20}, 377: {'weekly_order': 6, 'daily_order': 10}, 379: {'weekly_order': 5, 'daily_order': 20}, 380: {'weekly_order': 4, 'daily_order': 17}, 381: {'weekly_order': 3, 'daily_order': 5}, 382: {'weekly_order': 4, 'daily_order': 14}, 383: {'weekly_order': 8, 'daily_order': 14}, 384: {'weekly_order': 6, 'daily_order': 12}, 385: {'weekly_order': 5, 'daily_order': 18}, 386: {'weekly_order': 8, 'daily_order': 7}, 387: {'weekly_order': 10, 'daily_order': 20}, 388: {'weekly_order': 3, 'daily_order': 20}, 389: {'weekly_order': 8, 'daily_order': 12}, 391: {'weekly_order': 8, 'daily_order': 19}, 392: {'weekly_order': 6, 'daily_order': 16}, 393: {'weekly_order': 8, 'daily_order': 16}, 394: {'weekly_order': 4, 'daily_order': 14}, 395: {'weekly_order': 3, 'daily_order': 5}, 398: {'weekly_order': 6, 'daily_order': 19}, 399: {'weekly_order': 9, 'daily_order': 17}, 400: {'weekly_order': 5, 'daily_order': 17}, 401: {'weekly_order': 7, 'daily_order': 19}, 402: {'weekly_order': 5, 'daily_order': 8}, 403: {'weekly_order': 10, 'daily_order': 18}, 404: {'weekly_order': 9, 'daily_order': 18}, 405: {'weekly_order': 10, 'daily_order': 14}, 406: {'weekly_order': 7, 'daily_order': 18}, 407: {'weekly_order': 6, 'daily_order': 17}, 408: {'weekly_order': 4, 'daily_order': 12}, 409: {'weekly_order': 7, 'daily_order': 13}, 410: {'weekly_order': 9, 'daily_order': 13}, 411: {'weekly_order': 8, 'daily_order': 13}, 412: {'weekly_order': 4, 'daily_order': 19}, 413: {'weekly_order': 6, 'daily_order': 19}, 415: {'weekly_order': 4, 'daily_order': 13}, 416: {'weekly_order': 7, 'daily_order': 16}, 417: {'weekly_order': 8, 'daily_order': 6}, 418: {'weekly_order': 3, 'daily_order': 5}, 419: {'weekly_order': 3, 'daily_order': 20}, 420: {'weekly_order': 9, 'daily_order': 15}, 421: {'weekly_order': 7, 'daily_order': 7}, 424: {'weekly_order': 7, 'daily_order': 5}, 425: {'weekly_order': 4, 'daily_order': 16}, 427: {'weekly_order': 6, 'daily_order': 5}, 428: {'weekly_order': 5, 'daily_order': 12}, 430: {'weekly_order': 8, 'daily_order': 7}, 431: {'weekly_order': 7, 'daily_order': 8}, 432: {'weekly_order': 3, 'daily_order': 5}, 433: {'weekly_order': 3, 'daily_order': 18}, 434: {'weekly_order': 3, 'daily_order': 15}, 435: {'weekly_order': 7, 'daily_order': 17}, 436: {'weekly_order': 7, 'daily_order': 19}, 437: {'weekly_order': 3, 'daily_order': 20}, 438: {'weekly_order': 8, 'daily_order': 9}, 439: {'weekly_order': 8, 'daily_order': 10}, 440: {'weekly_order': 4, 'daily_order': 14}, 441: {'weekly_order': 8, 'daily_order': 16}, 442: {'weekly_order': 5, 'daily_order': 15}, 443: {'weekly_order': 8, 'daily_order': 20}, 444: {'weekly_order': 9, 'daily_order': 19}, 445: {'weekly_order': 8, 'daily_order': 15}, 446: {'weekly_order': 8, 'daily_order': 9}, 447: {'weekly_order': 6, 'daily_order': 18}, 448: {'weekly_order': 5, 'daily_order': 19}, 449: {'weekly_order': 8, 'daily_order': 20}, 450: {'weekly_order': 4, 'daily_order': 17}, 451: {'weekly_order': 5, 'daily_order': 6}, 452: {'weekly_order': 6, 'daily_order': 19}, 453: {'weekly_order': 8, 'daily_order': 16}, 454: {'weekly_order': 3, 'daily_order': 9}, 455: {'weekly_order': 9, 'daily_order': 20}, 457: {'weekly_order': 3, 'daily_order': 19}, 458: {'weekly_order': 3, 'daily_order': 20}, 459: {'weekly_order': 6, 'daily_order': 6}, 460: {'weekly_order': 8, 'daily_order': 18}, 461: {'weekly_order': 4, 'daily_order': 20}, 462: {'weekly_order': 3, 'daily_order': 10}, 463: {'weekly_order': 3, 'daily_order': 7}, 464: {'weekly_order': 4, 'daily_order': 11}, 465: {'weekly_order': 6, 'daily_order': 20}, 466: {'weekly_order': 8, 'daily_order': 19}, 467: {'weekly_order': 9, 'daily_order': 20}, 468: {'weekly_order': 10, 'daily_order': 20}, 469: {'weekly_order': 8, 'daily_order': 20}, 470: {'weekly_order': 10, 'daily_order': 20}, 472: {'weekly_order': 9, 'daily_order': 11}, 474: {'weekly_order': 10, 'daily_order': 20}, 475: {'weekly_order': 5, 'daily_order': 17}, 476: {'weekly_order': 9, 'daily_order': 17}, 477: {'weekly_order': 5, 'daily_order': 20}, 478: {'weekly_order': 10, 'daily_order': 20}, 479: {'weekly_order': 5, 'daily_order': 20}, 480: {'weekly_order': 5, 'daily_order': 12}, 481: {'weekly_order': 9, 'daily_order': 9}, 482: {'weekly_order': 4, 'daily_order': 18}, 483: {'weekly_order': 8, 'daily_order': 13}, 484: {'weekly_order': 9, 'daily_order': 8}, 485: {'weekly_order': 4, 'daily_order': 14}, 486: {'weekly_order': 3, 'daily_order': 17}, 487: {'weekly_order': 3, 'daily_order': 10}, 488: {'weekly_order': 7, 'daily_order': 20}, 489: {'weekly_order': 5, 'daily_order': 14}, 490: {'weekly_order': 6, 'daily_order': 17}, 491: {'weekly_order': 8, 'daily_order': 20}, 492: {'weekly_order': 3, 'daily_order': 14}, 493: {'weekly_order': 5, 'daily_order': 13}, 494: {'weekly_order': 4, 'daily_order': 12}, 495: {'weekly_order': 6, 'daily_order': 17}, 496: {'weekly_order': 7, 'daily_order': 16}, 497: {'weekly_order': 8, 'daily_order': 11}, 498: {'weekly_order': 3, 'daily_order': 14}, 500: {'weekly_order': 7, 'daily_order': 14}, 501: {'weekly_order': 6, 'daily_order': 11}, 502: {'weekly_order': 5, 'daily_order': 18}, 503: {'weekly_order': 10, 'daily_order': 8}, 504: {'weekly_order': 7, 'daily_order': 17}, 505: {'weekly_order': 5, 'daily_order': 12}, 506: {'weekly_order': 7, 'daily_order': 16}, 507: {'weekly_order': 6, 'daily_order': 10}, 509: {'weekly_order': 10, 'daily_order': 17}, 510: {'weekly_order': 10, 'daily_order': 18}, 512: {'weekly_order': 8, 'daily_order': 18}, 513: {'weekly_order': 8, 'daily_order': 11}, 514: {'weekly_order': 6, 'daily_order': 6}, 515: {'weekly_order': 5, 'daily_order': 9}, 516: {'weekly_order': 8, 'daily_order': 17}, 517: {'weekly_order': 8, 'daily_order': 15}, 518: {'weekly_order': 7, 'daily_order': 5}, 519: {'weekly_order': 4, 'daily_order': 15}, 520: {'weekly_order': 4, 'daily_order': 16}, 521: {'weekly_order': 6, 'daily_order': 20}, 523: {'weekly_order': 4, 'daily_order': 18}, 524: {'weekly_order': 3, 'daily_order': 11}, 526: {'weekly_order': 3, 'daily_order': 20}, 527: {'weekly_order': 4, 'daily_order': 16}, 528: {'weekly_order': 10, 'daily_order': 20}, 529: {'weekly_order': 6, 'daily_order': 8}, 530: {'weekly_order': 9, 'daily_order': 12}, 531: {'weekly_order': 5, 'daily_order': 16}, 532: {'weekly_order': 7, 'daily_order': 12}, 533: {'weekly_order': 3, 'daily_order': 18}, 534: {'weekly_order': 8, 'daily_order': 20}, 535: {'weekly_order': 8, 'daily_order': 5}, 536: {'weekly_order': 6, 'daily_order': 20}, 537: {'weekly_order': 6, 'daily_order': 18}, 538: {'weekly_order': 7, 'daily_order': 20}, 539: {'weekly_order': 9, 'daily_order': 11}, 540: {'weekly_order': 3, 'daily_order': 13}, 541: {'weekly_order': 9, 'daily_order': 7}, 542: {'weekly_order': 10, 'daily_order': 7}, 543: {'weekly_order': 4, 'daily_order': 12}, 544: {'weekly_order': 4, 'daily_order': 7}, 545: {'weekly_order': 9, 'daily_order': 14}, 546: {'weekly_order': 8, 'daily_order': 11}, 547: {'weekly_order': 7, 'daily_order': 8}, 551: {'weekly_order': 3, 'daily_order': 12}, 552: {'weekly_order': 8, 'daily_order': 17}, 553: {'weekly_order': 4, 'daily_order': 20}, 554: {'weekly_order': 10, 'daily_order': 13}, 555: {'weekly_order': 7, 'daily_order': 16}}

output_file = "results_optuna.txt"
results = []

# best_params_dict に含まれるファイルIDについてループ
for file_id in best_params_dict:
    csv_path = f"re_id/{file_id}.0.csv"
    
    if not os.path.exists(csv_path):
        results.append(f"File {csv_path} not found. Skipped.")
        continue
    
    try:
        df = pd.read_csv(csv_path, encoding="utf-8")
        # pattern_id をカテゴリ化
        df["pattern_id"] = df["pattern_id"].astype("category")

        # 数値化（カテゴリ → 数値）
        df["pattern_id_num"] = df["pattern_id"].cat.codes

        # マッピングを保存（数値 → 元のラベル）
        pattern_mapping = dict(enumerate(df["pattern_id"].cat.categories))


        # Prophet 用のデータフレームに変換
        df_prophet = df[['datetime', 'pattern_id_num']].copy()
        df_prophet.columns = ["ds", "y"]
        df_prophet["ds"] = pd.to_datetime(df_prophet["ds"], errors="coerce")
        df_prophet.dropna(inplace=True)

        # 祝日情報の作成
        holidays_list = [date for date in pd.date_range("2025-01-01", "2025-12-31") if jpholiday.is_holiday(date)]
        holidays_df = pd.DataFrame({
            "ds": holidays_list, 
            "holiday": [jpholiday.is_holiday_name(date) for date in holidays_list]
        })

        # 時刻情報を追加
        df_prophet["hour"] = df_prophet["ds"].dt.hour
        df_prophet["weekday"] = df_prophet["ds"].dt.weekday

        # 学習とテストの分割
        test_start_date = df_prophet["ds"].max() - timedelta(days=7)
        train = df_prophet[df_prophet["ds"] < test_start_date]
        test = df_prophet[df_prophet["ds"] >= test_start_date]

        if train.empty or test.empty:
            results.append(f"File {csv_path}: Not enough data for train/test split. Skipped.")
            continue

        # 辞書からパラメータを取得
        weekly_order = best_params_dict[file_id]['weekly_order']
        daily_order = best_params_dict[file_id]['daily_order']

        # Prophet モデルの構築・学習
        best_model = Prophet(holidays=holidays_df)
        best_model.add_seasonality(name="weekly", period=7, fourier_order=weekly_order)
        best_model.add_seasonality(name="daily", period=1, fourier_order=daily_order)
        best_model.add_regressor("hour")
        best_model.add_regressor("weekday")
        best_model.fit(train)

        future = test[["ds", "hour", "weekday"]].copy()
        forecast = best_model.predict(future)
        forecast["yhat_label"] = forecast["yhat"].round().astype(int)
        
        # 予測値（数値化された pattern_id）
        forecast["yhat_label"] = forecast["yhat"].round().astype(int)

        # 数値 → 元の pattern_id に変換
        forecast["pattern_id_predicted"] = forecast["yhat_label"].map(pattern_mapping)


        # # 評価指標の計算
        # test = test.reset_index(drop=True)
        # forecast = forecast.reset_index(drop=True)
        # mse = mean_squared_error(test["y"], forecast["yhat_label"])
        # mae = mean_absolute_error(test["y"], forecast["yhat_label"])
        # accuracy = np.mean(test["y"] == forecast["yhat_label"])

        # results.append(
        #     f"File {csv_path} | Best Fourier Orders: {best_params_dict[file_id]} | "
        #     f"MSE: {mse:.4f} | MAE: {mae:.4f} | Accuracy: {accuracy*100:.2f}%"
        # )
        
        # 学習済みモデルの保存
        model_save_path = f"models/model_{file_id}.joblib"
        os.makedirs(os.path.dirname(model_save_path), exist_ok=True)
        # モデルとマッピングを一緒に保存
        joblib.dump((best_model, pattern_mapping), model_save_path)



    except Exception as e:
        results.append(f"File {csv_path} encountered an error: {e}")

# # 結果を出力ファイルに保存
# with open(output_file, "w", encoding="utf-8") as f:
#     f.write("\n".join(results))

# print(f"結果が {output_file} に保存されました。")



